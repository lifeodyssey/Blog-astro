---
import { ui } from '@/i18n/ui'
import { getPageInfo } from '@/utils/page'

const { currentLang } = getPageInfo(Astro.url.pathname)
const currentUI = ui[currentLang as keyof typeof ui] ?? {}
---

<dialog id="search-modal" class="search-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">{currentUI.search || 'Search'}</h2>
      <button id="close-search-modal" class="close-btn" aria-label="Close">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div id="search-container" data-placeholder={currentUI.searchPlaceholder} data-no-results={currentUI.searchNoResults} data-results-found={currentUI.searchResultsFound}></div>
  </div>
</dialog>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet" />
<script is:inline src="/pagefind/pagefind-ui.js" type="text/javascript"></script>

<script>
let pagefindInitialized = false;

function initPagefind() {
  if (pagefindInitialized) return;
  if (typeof PagefindUI === 'undefined') return;

  const container = document.getElementById('search-container');
  const placeholder = container?.dataset.placeholder || 'Type to search...';

  new PagefindUI({
    element: '#search-container',
    showImages: false,
    showSubResults: true
  });

  // Set placeholder after initialization
  setTimeout(() => {
    const input = document.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
    if (input) input.placeholder = placeholder;
  }, 50);

  pagefindInitialized = true;
}

function openSearchModal() {
  const modal = document.getElementById('search-modal') as HTMLDialogElement;
  if (modal) {
    modal.showModal();
    initPagefind();
    setTimeout(() => {
      const input = modal.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
      input?.focus();
    }, 100);
  }
}

function closeSearchModal() {
  const modal = document.getElementById('search-modal') as HTMLDialogElement;
  modal?.close();
}

document.addEventListener('click', (e) => {
  const target = e.target as Element;
  if (target.closest('#search-button')) {
    e.preventDefault();
    openSearchModal();
  }
  if (target.closest('#close-search-modal')) {
    closeSearchModal();
  }
});

document.getElementById('search-modal')?.addEventListener('click', (e) => {
  const modal = e.currentTarget as HTMLDialogElement;
  const rect = modal.getBoundingClientRect();
  if (
    e.clientX < rect.left ||
    e.clientX > rect.right ||
    e.clientY < rect.top ||
    e.clientY > rect.bottom
  ) {
    closeSearchModal();
  }
});

(window as any).openSearchModal = openSearchModal;
</script>

<style is:global>
/* Modal Base */
.search-modal {
  padding: 0;
  border: none;
  border-radius: 12px;
  max-width: 600px;
  width: 90vw;
  background: transparent;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

.search-modal::backdrop {
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
}

.modal-content {
  background: var(--c-bg);
  border-radius: 12px;
  overflow: hidden;
}

/* Header */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--c-divider, rgba(128, 128, 128, 0.2));
}

.modal-title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--c-text-1);
  margin: 0;
}

.close-btn {
  padding: 0.25rem;
  background: transparent;
  border: none;
  color: var(--c-text-2);
  cursor: pointer;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.2s, background 0.2s;
}

.close-btn:hover {
  color: var(--c-text-1);
  background: rgba(128, 128, 128, 0.1);
}

/* Pagefind Container */
#search-container {
  padding: 0;
}

/* Pagefind UI Overrides */
.search-modal .pagefind-ui {
  --pagefind-ui-scale: 1;
  --pagefind-ui-primary: var(--c-primary, #3b82f6);
  --pagefind-ui-text: var(--c-text-1);
  --pagefind-ui-background: var(--c-bg);
  --pagefind-ui-border: var(--c-divider, rgba(128, 128, 128, 0.2));
  --pagefind-ui-border-width: 1px;
  --pagefind-ui-border-radius: 8px;
  --pagefind-ui-font: inherit;
}

.search-modal .pagefind-ui__form {
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--c-divider, rgba(128, 128, 128, 0.2));
}

.search-modal .pagefind-ui__search-input {
  font-size: 0.95rem !important;
  padding: 0.625rem 1rem !important;
  height: auto !important;
  background: var(--c-bg-soft, rgba(128, 128, 128, 0.05)) !important;
  border: 1px solid var(--c-divider, rgba(128, 128, 128, 0.2)) !important;
  border-radius: 8px !important;
  color: var(--c-text-1) !important;
  transition: border-color 0.2s, box-shadow 0.2s !important;
}

.search-modal .pagefind-ui__search-input:focus {
  outline: none !important;
  border-color: var(--c-primary, #3b82f6) !important;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
}

.search-modal .pagefind-ui__search-input::placeholder {
  color: var(--c-text-3, rgba(128, 128, 128, 0.6)) !important;
}

.search-modal .pagefind-ui__search-clear {
  padding: 0.5rem !important;
  right: 0.5rem !important;
  color: var(--c-text-3) !important;
  background: transparent !important;
}

.search-modal .pagefind-ui__search-clear:hover {
  color: var(--c-text-1) !important;
}

/* Results Area */
.search-modal .pagefind-ui__results-area {
  padding: 0 !important;
  margin: 0 !important;
}

.search-modal .pagefind-ui__message {
  padding: 1rem 1.25rem !important;
  font-size: 0.875rem !important;
  color: var(--c-text-2) !important;
  border-bottom: 1px solid var(--c-divider, rgba(128, 128, 128, 0.2)) !important;
}

.search-modal .pagefind-ui__results {
  max-height: 50vh;
  overflow-y: auto;
  padding: 0 !important;
}

/* Individual Result */
.search-modal .pagefind-ui__result {
  padding: 1rem 1.25rem !important;
  border-bottom: 1px solid var(--c-divider, rgba(128, 128, 128, 0.1)) !important;
  transition: background 0.15s !important;
}

.search-modal .pagefind-ui__result:hover {
  background: var(--c-bg-soft, rgba(128, 128, 128, 0.05)) !important;
}

.search-modal .pagefind-ui__result:last-child {
  border-bottom: none !important;
}

.search-modal .pagefind-ui__result-inner {
  padding: 0 !important;
}

.search-modal .pagefind-ui__result-title {
  margin-bottom: 0.375rem !important;
}

.search-modal .pagefind-ui__result-link {
  color: var(--c-text-1) !important;
  font-weight: 600 !important;
  font-size: 0.95rem !important;
  text-decoration: none !important;
  transition: color 0.15s !important;
}

.search-modal .pagefind-ui__result-link:hover {
  color: var(--c-primary, #3b82f6) !important;
}

.search-modal .pagefind-ui__result-link::before {
  content: "▸ " !important;
  color: var(--c-text-3) !important;
}

.search-modal .pagefind-ui__result-excerpt {
  font-size: 0.85rem !important;
  line-height: 1.5 !important;
  color: var(--c-text-2) !important;
  margin-top: 0.25rem !important;
}

/* Highlight */
.search-modal .pagefind-ui__result-excerpt mark,
.search-modal mark {
  background: rgba(250, 204, 21, 0.4) !important;
  color: inherit !important;
  padding: 0.1em 0.2em !important;
  border-radius: 2px !important;
}

/* Sub Results */
.search-modal .pagefind-ui__result-nested {
  margin-left: 1rem !important;
  padding-left: 0.75rem !important;
  border-left: 2px solid var(--c-divider, rgba(128, 128, 128, 0.2)) !important;
  margin-top: 0.5rem !important;
}

.search-modal .pagefind-ui__result-nested .pagefind-ui__result-link::before {
  content: "⤷ " !important;
}

/* Button */
.search-modal .pagefind-ui__button {
  margin: 1rem 1.25rem !important;
  padding: 0.625rem 1rem !important;
  background: var(--c-bg-soft, rgba(128, 128, 128, 0.05)) !important;
  border: 1px solid var(--c-divider, rgba(128, 128, 128, 0.2)) !important;
  border-radius: 8px !important;
  color: var(--c-text-2) !important;
  font-size: 0.875rem !important;
  cursor: pointer !important;
  transition: all 0.15s !important;
}

.search-modal .pagefind-ui__button:hover {
  background: var(--c-bg-mute, rgba(128, 128, 128, 0.1)) !important;
  color: var(--c-text-1) !important;
}

/* Hide default drawer toggle */
.search-modal .pagefind-ui__drawer {
  display: none !important;
}

/* Loading state */
.search-modal .pagefind-ui__loading {
  padding: 2rem 1.25rem !important;
  text-align: center !important;
  color: var(--c-text-3) !important;
}

/* Scrollbar styling */
.search-modal .pagefind-ui__results::-webkit-scrollbar {
  width: 6px;
}

.search-modal .pagefind-ui__results::-webkit-scrollbar-track {
  background: transparent;
}

.search-modal .pagefind-ui__results::-webkit-scrollbar-thumb {
  background: var(--c-divider, rgba(128, 128, 128, 0.3));
  border-radius: 3px;
}

.search-modal .pagefind-ui__results::-webkit-scrollbar-thumb:hover {
  background: var(--c-text-3, rgba(128, 128, 128, 0.5));
}
</style>
