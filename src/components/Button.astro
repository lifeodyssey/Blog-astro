---
import type { Language } from '@/i18n/config'
import LangEnIcon from '@/assets/icons/lang-en.svg'
import LangJaIcon from '@/assets/icons/lang-ja.svg'
import LangZhIcon from '@/assets/icons/lang-zh.svg'
import SearchIcon from '@/assets/icons/search-icon.svg'
import ThemeToggleIcon from '@/assets/icons/theme-toggle.svg'
import { allLocales, moreLocales, themeConfig } from '@/config'
import { getNextGlobalLangPath, getNextSupportedLangPath } from '@/i18n/path'
import { getPageInfo } from '@/utils/page'

interface Props {
  supportedLangs: Language[]
}

const {
  light: { background: lightMode },
  dark: { background: darkMode },
} = themeConfig.color

const { supportedLangs } = Astro.props
const currentPath = Astro.url.pathname
const { currentLang } = getPageInfo(currentPath)

const effectiveLangs = supportedLangs.length > 0 ? supportedLangs : allLocales
const showLanguageSwitcher = moreLocales.length > 0 && effectiveLangs.length > 1

// Choose a language switch list according to supported languages (when available)
const nextUrl = supportedLangs.length > 1
  ? getNextSupportedLangPath(currentPath, supportedLangs)
  : getNextGlobalLangPath(currentPath)

// Determine which icon to show based on current language
// Show the icon of the NEXT language user will switch to
const langIconMap: Record<string, typeof LangEnIcon> = {
  'zh': LangEnIcon,    // zh → en, show "A"
  'en': LangJaIcon,    // en → ja, show "あ"
  'ja': LangZhIcon,    // ja → zh, show "汉"
}
const CurrentLangIcon = langIconMap[currentLang] || LangEnIcon
---

<div
  class:list={[
  'absolute right-7.25vw top-14.6 flex gap-6 min-[823px]:max-lg:right-[calc(50vw-22rem)]',
  'lg:(fixed bottom-[min(10.27rem+1.92vw,12rem)] right-[max(5rem,calc(50vw-35rem))] top-auto w-14rem)',
]}
>
  <!-- Search Button -->
  <button
    id="search-button"
    class="aspect-square w-4 c-secondary active:scale-90 hover:c-primary"
    aria-label="Search"
  >
    <SearchIcon aria-hidden="true" fill="currentColor" />
  </button>

  <!-- Language Switcher -->
  {showLanguageSwitcher && (
    <a
      id="language-switcher"
      href={nextUrl}
      class="aspect-square w-4 c-secondary active:scale-90 hover:c-primary"
      aria-label="Switch website language"
    >
      <CurrentLangIcon
        aria-hidden="true"
        fill="currentColor"
      />
    </a>
  )}

  <!-- Theme Toggle -->
  <button
    id="theme-toggle-button"
    class="aspect-square w-4 c-secondary active:scale-90 hover:c-primary"
    data-light-mode={lightMode}
    data-dark-mode={darkMode}
    aria-label="Switch light/dark theme"
  >
    <ThemeToggleIcon
      aria-hidden="true"
      fill="currentColor"
    />
  </button>
</div>

<!-- Theme Toggle Script >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> -->
<script>
// Apply theme changes
function applyTheme(isDark: boolean) {
  document.documentElement.classList.toggle('dark', isDark)

  // Update meta theme-color tag
  const metaThemeColor = document.head.querySelector('meta[name="theme-color"]')
  const themeButton = document.getElementById('theme-toggle-button')
  const lightMode = themeButton?.dataset.lightMode
  const darkMode = themeButton?.dataset.darkMode

  if (metaThemeColor && lightMode && darkMode) {
    metaThemeColor.setAttribute('content', isDark ? darkMode : lightMode)
  }

  localStorage.setItem('theme', isDark ? 'dark' : 'light')
  document.dispatchEvent(new Event('theme-changed'))
}

// Toggle theme mode
function toggleTheme() {
  const isDark = !document.documentElement.classList.contains('dark')
  applyTheme(isDark)
}

// Handle theme toggle click events
function handleThemeToggle(e: MouseEvent) {
  if (!(e.target instanceof Element)) {
    return
  }

  if (!e.target.closest('#theme-toggle-button')) {
    return
  }

  // If reduceMotion is enabled, update theme directly
  if (document.documentElement.classList.contains('reduce-motion')) {
    toggleTheme()
    return
  }

  // Add temporary markers before view transition
  document.documentElement.style.setProperty('view-transition-name', 'theme-toggle-transition')
  document.documentElement.setAttribute('data-theme-changing', '')

  // Use View Transitions API for theme toggle
  const transition = document.startViewTransition(toggleTheme)

  // Remove temporary markers after view transition
  transition.finished.then(() => {
    document.documentElement.style.removeProperty('view-transition-name')
    document.documentElement.removeAttribute('data-theme-changing')
  })
}

// Listen to system theme changes in real time
function handleSystemChange(event: MediaQueryListEvent) {
  const isDark = event.matches
  applyTheme(isDark)
}

document.addEventListener('click', handleThemeToggle)
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', handleSystemChange)
</script>
