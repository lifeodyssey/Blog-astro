---
interface Props {
  currentPage: number
  totalPages: number
  baseUrl: string
  pagePrefix?: string
}

const { currentPage, totalPages, baseUrl, pagePrefix } = Astro.props

// Generate page URL - page 1 has no suffix, others have /2, /3, etc.
function getPageUrl(page: number): string {
  if (page === 1) {
    return baseUrl
  }
  // Remove trailing slash from baseUrl if present, then add page number
  const cleanBase = baseUrl.replace(/\/$/, '')
  return pagePrefix
    ? `${cleanBase}/${pagePrefix}/${page}`
    : `${cleanBase}/${page}`
}

const hasPrev = currentPage > 1
const hasNext = currentPage < totalPages
const prevUrl = hasPrev ? getPageUrl(currentPage - 1) : null
const nextUrl = hasNext ? getPageUrl(currentPage + 1) : null

// Generate visible page numbers (show max 5 pages around current)
function getVisiblePages(): number[] {
  const pages: number[] = []
  const maxVisible = 5
  let start = Math.max(1, currentPage - Math.floor(maxVisible / 2))
  let end = Math.min(totalPages, start + maxVisible - 1)

  // Adjust start if we're near the end
  if (end - start + 1 < maxVisible) {
    start = Math.max(1, end - maxVisible + 1)
  }

  for (let i = start; i <= end; i++) {
    pages.push(i)
  }
  return pages
}

const visiblePages = getVisiblePages()
---

{totalPages > 1 && (
  <nav
    class="pagination"
    aria-label="Pagination"
    data-base-url={baseUrl}
    data-total-pages={totalPages}
    data-page-prefix={pagePrefix}
  >
    <div class="pagination-inner">
      {/* Previous button */}
      {hasPrev ? (
        <a href={prevUrl} class="pagination-btn" aria-label="Previous page">
          <span class="pagination-arrow">‹</span>
          <span class="pagination-text">Prev</span>
        </a>
      ) : (
        <span class="pagination-btn disabled" aria-disabled="true">
          <span class="pagination-arrow">‹</span>
          <span class="pagination-text">Prev</span>
        </span>
      )}

      {/* Page numbers */}
      <div class="pagination-pages">
        {visiblePages[0] > 1 && (
          <>
            <a href={getPageUrl(1)} class="pagination-page">1</a>
            {visiblePages[0] > 2 && (
              <div class="pagination-ellipsis-wrapper">
                <button type="button" class="pagination-ellipsis" aria-label="Jump to page">•••</button>
                <input
                  type="number"
                  class="pagination-input"
                  min="1"
                  max={totalPages}
                  placeholder="Go"
                  aria-label="Enter page number"
                />
              </div>
            )}
          </>
        )}

        {visiblePages.map(page => (
          page === currentPage ? (
            <span class="pagination-page current" aria-current="page">{page}</span>
          ) : (
            <a href={getPageUrl(page)} class="pagination-page">{page}</a>
          )
        ))}

        {visiblePages[visiblePages.length - 1] < totalPages && (
          <>
            {visiblePages[visiblePages.length - 1] < totalPages - 1 && (
              <div class="pagination-ellipsis-wrapper">
                <button type="button" class="pagination-ellipsis" aria-label="Jump to page">•••</button>
                <input
                  type="number"
                  class="pagination-input"
                  min="1"
                  max={totalPages}
                  placeholder="Go"
                  aria-label="Enter page number"
                />
              </div>
            )}
            <a href={getPageUrl(totalPages)} class="pagination-page">{totalPages}</a>
          </>
        )}
      </div>

      {/* Next button */}
      {hasNext ? (
        <a href={nextUrl} class="pagination-btn" aria-label="Next page">
          <span class="pagination-text">Next</span>
          <span class="pagination-arrow">›</span>
        </a>
      ) : (
        <span class="pagination-btn disabled" aria-disabled="true">
          <span class="pagination-text">Next</span>
          <span class="pagination-arrow">›</span>
        </span>
      )}
    </div>
  </nav>
)}

<style>
.pagination {
  --at-apply: 'mt-10 mb-6';
}

.pagination-inner {
  --at-apply: 'flex items-center justify-center gap-0';
}

.pagination-btn {
  --at-apply: 'flex items-center gap-1 px-3 py-2 text-sm c-secondary hover:c-primary transition-colors duration-200';
  letter-spacing: 0.05em;
}

.pagination-btn.disabled {
  --at-apply: 'c-tertiary/35 cursor-not-allowed hover:c-tertiary/35';
}

.pagination-arrow {
  --at-apply: 'text-base';
}

.pagination-text {
  --at-apply: 'hidden sm:inline';
}

.pagination-pages {
  --at-apply: 'flex items-center gap-0 border-l border-r border-secondary/30';
}

.pagination-page {
  --at-apply: 'min-w-9 h-9 flex items-center justify-center text-sm c-secondary hover:c-primary transition-colors duration-200 font-serif';
}

.pagination-page.current {
  --at-apply: 'c-primary font-semibold';
  text-decoration: underline;
  text-underline-offset: 4px;
  text-decoration-thickness: 1.5px;
}

.pagination-ellipsis-wrapper {
  --at-apply: 'relative';
}

.pagination-ellipsis {
  --at-apply: 'min-w-8 h-9 flex items-center justify-center text-sm c-tertiary hover:c-primary cursor-pointer transition-colors duration-200 border-none bg-transparent';
  letter-spacing: 0.1em;
}

.pagination-ellipsis.hidden {
  --at-apply: 'invisible w-0 min-w-0 overflow-hidden';
}

.pagination-input {
  --at-apply: 'absolute top-0 left-0 w-12 h-9 text-sm text-center rounded c-primary bg-secondary/10 border border-secondary/30 outline-none transition-all duration-200 opacity-0 invisible font-serif';
}

.pagination-input:focus {
  --at-apply: 'border-primary/60';
}

.pagination-input.active {
  --at-apply: 'opacity-100 visible';
}

/* Hide number input spinners */
.pagination-input::-webkit-outer-spin-button,
.pagination-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.pagination-input[type=number] {
  -moz-appearance: textfield;
}
</style>

<script>
document.addEventListener('astro:page-load', initPagination);
document.addEventListener('DOMContentLoaded', initPagination);

function initPagination() {
  const nav = document.querySelector('.pagination') as HTMLElement | null;
  if (!nav) return;

  const baseUrl = nav.dataset.baseUrl || '';
  const totalPages = parseInt(nav.dataset.totalPages || '1', 10);
  const pagePrefix = nav.dataset.pagePrefix || '';

  document.querySelectorAll('.pagination-ellipsis').forEach(btn => {
    btn.addEventListener('click', () => {
      const wrapper = btn.closest('.pagination-ellipsis-wrapper');
      const input = wrapper?.querySelector('.pagination-input') as HTMLInputElement | null;
      if (!input) return;

      btn.classList.add('hidden');
      input.classList.add('active');
      input.focus();
    });
  });

  document.querySelectorAll<HTMLInputElement>('.pagination-input').forEach(input => {
    const wrapper = input.closest('.pagination-ellipsis-wrapper');
    const btn = wrapper?.querySelector('.pagination-ellipsis');

    input.addEventListener('blur', () => {
      input.classList.remove('active');
      input.value = '';
      btn?.classList.remove('hidden');
    });

    input.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const page = parseInt(input.value, 10);
        if (page >= 1 && page <= totalPages) {
          const cleanBase = baseUrl.replace(/\/$/, '');
          const url = page === 1
            ? baseUrl
            : pagePrefix
              ? `${cleanBase}/${pagePrefix}/${page}`
              : `${cleanBase}/${page}`;
          window.location.href = url;
        }
      } else if (e.key === 'Escape') {
        input.blur();
      }
    });
  });
}
</script>
